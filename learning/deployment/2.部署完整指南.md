# DocStudio 项目部署完整指南

本文档介绍如何将 DocStudio 项目从开发环境部署到生产环境，涵盖 Docker 容器化、环境配置、数据库迁移、CI/CD 流程等关键内容。

## 1. 架构概览

DocStudio 采用 **Monorepo + Docker** 架构：

```
┌─────────────────────────────────────────────┐
│            Nginx (反向代理)                  │
│        SSL 终止 + 负载均衡                    │
└──────────┬──────────────────┬───────────────┘
           │                  │
    ┌──────▼──────┐    ┌──────▼──────┐
    │  Next.js    │    │   NestJS    │
    │  (前端)     │    │   (后端)    │
    │  Port 3000  │    │  Port 3001  │
    └─────────────┘    └──────┬──────┘
                              │
           ┌──────────────────┼──────────────────┐
           │                  │                  │
    ┌──────▼──────┐   ┌───────▼──────┐  ┌───────▼──────┐
    │ PostgreSQL  │   │    Redis     │  │    MinIO     │
    │ (数据库)    │   │   (缓存)     │  │  (对象存储)  │
    │  Port 5432  │   │  Port 6379   │  │  Port 9000   │
    └─────────────┘   └──────────────┘  └──────────────┘
```

## 2. 开发环境 vs 生产环境

| 组件       | 开发环境        | 生产环境             |
| ---------- | --------------- | -------------------- |
| Next.js    | 本地 `pnpm dev` | Docker 容器 (构建后) |
| NestJS     | 本地 `pnpm dev` | Docker 容器 (构建后) |
| PostgreSQL | Docker Compose  | 云数据库或 Docker    |
| Redis      | Docker Compose  | 云服务或 Docker      |
| MinIO      | Docker Compose  | AWS S3 或自建        |
| Nginx      | 无              | Docker 容器          |

## 3. Docker 容器化

### 创建 Dockerfile (Next.js)

创建 `apps/web/Dockerfile`:

```dockerfile
# 多阶段构建
FROM node:22-alpine AS base

# 安装 pnpm
RUN npm install -g pnpm

# 依赖阶段
FROM base AS deps
WORKDIR /app

# 复制依赖文件
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY apps/web/package.json ./apps/web/
COPY packages ./packages

# 安装生产依赖
RUN pnpm install --frozen-lockfile --prod

# 构建阶段
FROM base AS builder
WORKDIR /app

# 复制依赖
COPY --from=deps /app/node_modules ./node_modules
COPY . .

# 构建 Next.js
WORKDIR /app/apps/web
ENV NEXT_TELEMETRY_DISABLED 1
RUN pnpm build

# 运行阶段
FROM base AS runner
WORKDIR /app

ENV NODE_ENV production
ENV NEXT_TELEMETRY_DISABLED 1

# 创建非 root 用户
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# 复制构建产物
COPY --from=builder /app/apps/web/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/apps/web/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/apps/web/.next/static ./.next/static

USER nextjs

EXPOSE 3000
ENV PORT 3000

CMD ["node", "server.js"]
```

**关键配置**：在 `apps/web/next.config.js` 中启用 `standalone` 输出：

```javascript
module.exports = {
  output: 'standalone',
};
```

### 创建 Dockerfile (NestJS)

创建 `apps/api/Dockerfile`:

```dockerfile
FROM node:22-alpine AS base
RUN npm install -g pnpm

# 依赖阶段
FROM base AS deps
WORKDIR /app

COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY apps/api/package.json ./apps/api/
COPY packages ./packages

RUN pnpm install --frozen-lockfile --prod

# 构建阶段
FROM base AS builder
WORKDIR /app

COPY --from=deps /app/node_modules ./node_modules
COPY . .

WORKDIR /app/apps/api

# 生成 Prisma Client
RUN pnpm exec prisma generate

# 构建 NestJS
RUN pnpm build

# 运行阶段
FROM base AS runner
WORKDIR /app

ENV NODE_ENV production

# 复制构建产物
COPY --from=builder /app/apps/api/dist ./dist
COPY --from=builder /app/apps/api/node_modules ./node_modules
COPY --from=builder /app/apps/api/prisma ./prisma

EXPOSE 3001

CMD ["node", "dist/main"]
```

### 创建生产 docker-compose.yml

创建 `docker-compose.prod.yml`:

```yaml
version: '3.8'

services:
  # Nginx 反向代理
  nginx:
    image: nginx:alpine
    container_name: DocStudio-nginx
    restart: unless-stopped
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - web
      - api
    networks:
      - DocStudio-network

  # Next.js 前端
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
    container_name: DocStudio-web
    restart: unless-stopped
    environment:
      - NEXT_PUBLIC_API_URL=https://api.yourdomain.com
    networks:
      - DocStudio-network

  # NestJS 后端
  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    container_name: DocStudio-api
    restart: unless-stopped
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - JWT_SECRET=${JWT_SECRET}
      - NODE_ENV=production
    depends_on:
      - postgres
      - redis
    networks:
      - DocStudio-network

  # PostgreSQL 数据库
  postgres:
    image: postgres:16-alpine
    container_name: DocStudio-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - DocStudio-network

  # Redis 缓存
  redis:
    image: redis:7-alpine
    container_name: DocStudio-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    networks:
      - DocStudio-network

  # MinIO 对象存储
  minio:
    image: minio/minio:latest
    container_name: DocStudio-minio
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    networks:
      - DocStudio-network

volumes:
  postgres_data:
  redis_data:
  minio_data:

networks:
  DocStudio-network:
    driver: bridge
```

## 4. Nginx 配置

创建 `nginx/nginx.conf`:

```nginx
events {
    worker_connections 1024;
}

http {
    # 上游服务器
    upstream web {
        server web:3000;
    }

    upstream api {
        server api:3001;
    }

    # HTTP -> HTTPS 重定向
    server {
        listen 80;
        server_name yourdomain.com www.yourdomain.com;
        return 301 https://$server_name$request_uri;
    }

    # HTTPS 主站 (Next.js)
    server {
        listen 443 ssl http2;
        server_name yourdomain.com www.yourdomain.com;

        ssl_certificate /etc/nginx/ssl/fullchain.pem;
        ssl_certificate_key /etc/nginx/ssl/privkey.pem;

        # SSL 优化
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;

        # Gzip 压缩
        gzip on;
        gzip_types text/plain text/css application/json application/javascript;

        location / {
            proxy_pass http://web;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }
    }

    # HTTPS API (NestJS)
    server {
        listen 443 ssl http2;
        server_name api.yourdomain.com;

        ssl_certificate /etc/nginx/ssl/fullchain.pem;
        ssl_certificate_key /etc/nginx/ssl/privkey.pem;

        location / {
            proxy_pass http://api;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
```

## 5. 环境变量管理

创建 `.env.production`:

```env
# 数据库
POSTGRES_USER=DocStudio_user
POSTGRES_PASSWORD=<strong-password>
POSTGRES_DB=DocStudio_production
DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}?schema=public

# Redis
REDIS_PASSWORD=<strong-redis-password>

# JWT
JWT_SECRET=<strong-random-secret-min-32-chars>
JWT_EXPIRES_IN=7d

# MinIO
MINIO_ROOT_USER=<minio-admin>
MINIO_ROOT_PASSWORD=<strong-minio-password>

# 其他
NODE_ENV=production
```

**安全提示**:

- 不要将 `.env.production` 提交到 Git。
- 使用 `openssl rand -base64 32` 生成强密钥。
- 生产环境使用云服务商的密钥管理服务（AWS Secrets Manager, Azure Key Vault）。

## 6. 数据库迁移流程

### 本地到生产的迁移步骤

```bash
# 1. 在本地开发完成 Schema 变更
cd apps/api
pnpm exec prisma migrate dev --name add_new_feature

# 2. 提交 migration 文件到 Git
git add prisma/migrations/
git commit -m "feat: add new feature migration"

# 3. 部署到生产环境后，执行迁移
# (在生产服务器或 CI/CD 中)
cd apps/api
pnpm exec prisma migrate deploy
```

### 生产环境数据库备份

```bash
# 备份
docker exec DocStudio-postgres pg_dump -U DocStudio_user DocStudio_production > backup_$(date +%Y%m%d).sql

# 恢复
docker exec -i DocStudio-postgres psql -U DocStudio_user DocStudio_production < backup_20260203.sql
```

## 7. 部署流程

### 手动部署

```bash
# 1. 拉取最新代码
git pull origin main

# 2. 设置环境变量
cp .env.production .env

# 3. 构建并启动容器
docker-compose -f docker-compose.prod.yml up -d --build

# 4. 运行数据库迁移
docker exec DocStudio-api sh -c "cd /app && npx prisma migrate deploy"

# 5. 查看日志
docker-compose -f docker-compose.prod.yml logs -f
```

### 自动部署 (GitHub Actions)

创建 `.github/workflows/deploy.yml`:

```yaml
name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push images
        run: |
          docker-compose -f docker-compose.prod.yml build
          docker-compose -f docker-compose.prod.yml push

      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/DocStudio
            git pull
            docker-compose -f docker-compose.prod.yml pull
            docker-compose -f docker-compose.prod.yml up -d
            docker exec DocStudio-api npx prisma migrate deploy
```

## 8. 生产环境优化

### Next.js 优化

```javascript
// next.config.js
module.exports = {
  output: 'standalone',
  compress: true, // Gzip 压缩
  poweredByHeader: false, // 移除 X-Powered-By 头
  generateEtags: false, // 禁用 ETag (Nginx 处理)

  // 图片优化
  images: {
    domains: ['yourdomain.com'],
    formats: ['image/avif', 'image/webp'],
  },
};
```

### NestJS 优化

```typescript
// main.ts
async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  // CORS
  app.enableCors({
    origin: process.env.FRONTEND_URL,
    credentials: true,
  });

  // Helmet (安全头)
  app.use(helmet());

  // 速率限制
  app.use(
    rateLimit({
      windowMs: 15 * 60 * 1000,
      max: 100,
    })
  );

  // 全局前缀
  app.setGlobalPrefix('api');

  await app.listen(3001);
}
```

## 9. 监控与日志

### Docker 日志管理

```bash
# 查看所有日志
docker-compose logs -f

# 查看特定服务
docker-compose logs -f api

# 限制日志大小 (docker-compose.yml)
logging:
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
```

### 健康检查

在 `docker-compose.prod.yml` 中添加健康检查：

```yaml
api:
  healthcheck:
    test: ['CMD', 'curl', '-f', 'http://localhost:3001/health']
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 40s
```

## 10. SSL 证书配置

### 使用 Let's Encrypt (Certbot)

```bash
# 安装 Certbot
sudo apt-get install certbot

# 获取证书
sudo certbot certonly --standalone -d yourdomain.com -d www.yourdomain.com

# 证书会保存在 /etc/letsencrypt/live/yourdomain.com/
# 复制到项目目录
sudo cp /etc/letsencrypt/live/yourdomain.com/fullchain.pem ./nginx/ssl/
sudo cp /etc/letsencrypt/live/yourdomain.com/privkey.pem ./nginx/ssl/

# 自动续期
sudo certbot renew --dry-run
```

## 11. 常见问题

### 容器无法启动

```bash
docker-compose logs api
docker-compose ps
```

### 数据库连接失败

- 检查 `DATABASE_URL` 是否正确
- 确认 PostgreSQL 容器已启动
- 查看防火墙规则

### 内存不足

```bash
# 限制容器内存
services:
  api:
    mem_limit: 512m
    memswap_limit: 512m
```

## 12. 安全检查清单

- [ ] 所有密码使用强随机字符串
- [ ] `.env` 文件不提交到 Git
- [ ] 启用 HTTPS (SSL/TLS)
- [ ] 配置防火墙 (仅开放 80, 443)
- [ ] 使用非 root 用户运行容器
- [ ] 定期更新 Docker 镜像
- [ ] 配置数据库备份计划
- [ ] 启用 API 速率限制
- [ ] 配置 CORS 白名单
- [ ] 定期审计依赖漏洞 (`pnpm audit`)

## 13. 回滚策略

```bash
# 保留旧版本镜像
docker tag DocStudio-api:latest DocStudio-api:backup-$(date +%Y%m%d)

# 回滚到上一版本
docker-compose down
git checkout <previous-commit>
docker-compose up -d

# 回滚数据库
docker exec -i DocStudio-postgres psql -U user db < backup.sql
```
