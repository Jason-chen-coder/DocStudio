# DevOps 基础知识 - 前端工程师入门指南

本文档面向前端工程师，介绍部署和运维相关的核心概念，帮助你理解《部署完整指南》中涉及的技术。

## 1. 什么是部署？

**部署 (Deployment)** = 将你的代码从开发环境搬到生产环境，让真实用户可以访问。

### 开发环境 vs 生产环境

| 环境                       | 说明                 | 特点                                            |
| -------------------------- | -------------------- | ----------------------------------------------- |
| **开发环境** (Development) | 你的本地电脑         | `npm run dev`，热重载，有详细报错，速度优先     |
| **生产环境** (Production)  | 真实用户访问的服务器 | `npm run build`，优化打包，隐藏报错，稳定性优先 |

简单理解：开发环境是你的"草稿本"，生产环境是"正式出版物"。

## 2. Docker 基础

### 什么是 Docker？

Docker 就像一个"集装箱"系统，把你的应用和所有依赖（Node.js、数据库、环境变量）打包在一起。

**类比**：

- **虚拟机** = 买一套完整的房子（笨重、启动慢）
- **Docker 容器** = 租一个集装箱（轻量、启动快）

### 核心概念

#### 1. 镜像 (Image)

- **是什么**：应用的"模板"或"安装包"。
- **类比**：就像 macOS 的 `.dmg` 安装文件。
- **例子**：`node:22-alpine` 是一个包含 Node.js 22 的镜像。

#### 2. 容器 (Container)

- **是什么**：镜像运行起来的实例。
- **类比**：镜像是"游戏安装包"，容器是"正在玩的游戏"。
- **特点**：隔离、独立、可销毁重建。

#### 3. Dockerfile

- **是什么**：构建镜像的"配方"或"说明书"。
- **类比**：烹饪菜谱，告诉 Docker 如何一步步制作镜像。

```dockerfile
# 示例 Dockerfile
FROM node:22-alpine      # 1. 基于 Node.js 镜像
WORKDIR /app             # 2. 设置工作目录
COPY package.json ./     # 3. 复制依赖文件
RUN npm install          # 4. 安装依赖
COPY . .                 # 5. 复制源代码
CMD ["npm", "start"]     # 6. 启动命令
```

#### 4. Docker Compose

- **是什么**：管理多个容器的工具（一键启动数据库 + 后端 + 前端）。
- **类比**：乐队指挥，协调多个乐器（容器）同时演奏。
- **文件**：`docker-compose.yml`

```yaml
services:
  web: # 前端容器
    build: ./web
    ports:
      - '3000:3000'

  api: # 后端容器
    build: ./api
    ports:
      - '3001:3001'

  db: # 数据库容器
    image: postgres:16
    ports:
      - '5432:5432'
```

### 常用命令

```bash
# 构建镜像
docker build -t my-app .

# 运行容器
docker run -p 3000:3000 my-app

# 查看运行中的容器
docker ps

# 停止容器
docker stop <容器ID>

# 删除容器
docker rm <容器ID>

# 使用 Docker Compose
docker-compose up -d        # 启动所有服务
docker-compose down         # 停止所有服务
docker-compose logs -f      # 查看日志
```

## 3. 环境变量 (Environment Variables)

### 什么是环境变量？

环境变量是存储敏感信息（密码、API Key）的"密码本"。

**为什么不直接写在代码里？**

- ❌ 代码会被推送到 GitHub，密码泄露。
- ❌ 不同环境需要不同的值（开发用测试数据库，生产用正式数据库）。

### .env 文件

```env
# .env 文件示例
DATABASE_URL=postgresql://user:password@localhost:5432/mydb
JWT_SECRET=super-secret-key-12345
NODE_ENV=production
```

### 在代码中使用

```javascript
// Node.js
const dbUrl = process.env.DATABASE_URL;

// Next.js (客户端可见)
const apiUrl = process.env.NEXT_PUBLIC_API_URL;
```

**安全规则**：

- ✅ 提交 `.env.example` (模板，不含真实值)
- ❌ 提交 `.env` (真实密码)
- 在 `.gitignore` 中添加 `.env`

## 4. 反向代理 (Reverse Proxy)

### 什么是 Nginx？

Nginx 是一个"交通警察"，将用户请求分发到正确的服务。

**场景**：

- 前端运行在 `http://localhost:3000`
- 后端运行在 `http://localhost:3001`
- 用户只想访问 `https://yourdomain.com`

**Nginx 的作用**：

```
用户访问 https://yourdomain.com        → Nginx → 转发到前端 (3000)
用户访问 https://yourdomain.com/api    → Nginx → 转发到后端 (3001)
```

### 额外功能

- **SSL 终止**：处理 HTTPS 加密/解密。
- **负载均衡**：流量大时分发到多台服务器。
- **静态文件服务**：直接返回图片/CSS/JS，无需经过后端。

## 5. SSL/TLS 证书 (HTTPS)

### HTTP vs HTTPS

| 协议  | 加密        | 安全性 | 浏览器显示  |
| ----- | ----------- | ------ | ----------- |
| HTTP  | ❌ 明文传输 | 不安全 | ⚠️ "不安全" |
| HTTPS | ✅ 加密传输 | 安全   | 🔒 绿色锁   |

### 什么是 SSL 证书？

SSL 证书是"网站的身份证"，证明你的网站是真实的，同时加密通信内容。

### 如何获取免费证书？

使用 **Let's Encrypt** (免费、自动化)：

```bash
# 安装 Certbot
sudo apt-get install certbot

# 获取证书
sudo certbot certonly --standalone -d yourdomain.com

# 证书位置
/etc/letsencrypt/live/yourdomain.com/fullchain.pem   # 公钥
/etc/letsencrypt/live/yourdomain.com/privkey.pem     # 私钥
```

证书有效期 90 天，需要定期续期（可以设置自动续期）。

## 6. CI/CD 持续集成与部署

### 什么是 CI/CD？

- **CI (Continuous Integration)** = 持续集成：每次提交代码，自动运行测试。
- **CD (Continuous Deployment)** = 持续部署：测试通过后，自动部署到服务器。

**传统方式**（手动）：

```
1. 写代码
2. 本地测试
3. 推送到 GitHub
4. SSH 连接服务器
5. 手动 git pull
6. 手动 docker-compose up
7. 祈祷不出错 🙏
```

**CI/CD 方式**（自动）：

```
1. 写代码
2. 推送到 GitHub
3. GitHub Actions 自动运行测试
4. 自动部署到服务器
5. 喝咖啡 ☕️
```

### GitHub Actions 示例

创建 `.github/workflows/deploy.yml`：

```yaml
name: Deploy

on:
  push:
    branches: [main] # 推送到 main 分支时触发

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3 # 1. 拉取代码
      - uses: actions/setup-node@v3 # 2. 安装 Node.js
        with:
          node-version: 22
      - run: npm install # 3. 安装依赖
      - run: npm run build # 4. 构建
      - run: npm test # 5. 测试
      # 6. 部署到服务器 (SSH)
```

## 7. 数据库迁移 (Database Migration)

### 什么是迁移？

迁移 = 数据库结构的"版本管理"（类似 Git 管理代码）。

**场景**：你在开发时给 `users` 表新增了一个 `phone` 字段。

**不用迁移**（危险）：

```sql
-- 手动在生产数据库执行
ALTER TABLE users ADD COLUMN phone VARCHAR(20);
```

问题：没有记录，团队成员不知道，容易遗漏。

**使用迁移**（推荐）：

```bash
# 1. 修改 Prisma Schema
model User {
  id    Int    @id
  email String
  phone String?  // 新增字段
}

# 2. 生成迁移文件
npx prisma migrate dev --name add_phone_field

# 3. 提交到 Git
git add prisma/migrations/
git commit -m "feat: add phone field"

# 4. 部署时自动执行
npx prisma migrate deploy
```

优势：

- ✅ 有记录、可追溯
- ✅ 可回滚
- ✅ 团队同步

## 8. 日志与监控

### 什么是日志？

日志 = 应用运行时的"黑匣子记录"，用于排查问题。

```javascript
// 开发环境
console.log('用户登录成功', user);

// 生产环境（结构化日志）
logger.info('User logged in', { userId: user.id, ip: req.ip });
```

### 查看 Docker 日志

```bash
# 查看所有容器日志
docker-compose logs -f

# 查看特定容器
docker-compose logs -f api

# 查看最新 100 行
docker-compose logs --tail=100 api
```

### 生产环境监控

常用工具：

- **日志聚合**：ELK Stack (Elasticsearch + Logstash + Kibana)
- **性能监控**：New Relic, Datadog
- **错误追踪**：Sentry
- **服务器监控**：Prometheus + Grafana

## 9. 域名与 DNS

### 域名解析流程

```
用户输入 yourdomain.com
    ↓
DNS 查询（域名 → IP 地址）
    ↓
找到你的服务器 IP: 123.45.67.89
    ↓
浏览器连接到你的服务器
    ↓
Nginx 接收请求并转发
```

### DNS 记录类型

| 类型      | 说明               | 示例                                  |
| --------- | ------------------ | ------------------------------------- |
| **A**     | 域名指向 IPv4 地址 | `yourdomain.com → 123.45.67.89`       |
| **CNAME** | 域名别名           | `www.yourdomain.com → yourdomain.com` |
| **MX**    | 邮件服务器         | `mail.yourdomain.com`                 |

配置示例（在域名服务商后台）：

```
类型   主机记录   记录值
A      @          123.45.67.89
A      www        123.45.67.89
CNAME  api        yourdomain.com
```

## 10. 服务器基础

### 云服务器选择

| 平台        | 优势           | 适合场景     |
| ----------- | -------------- | ------------ |
| **AWS**     | 功能最全       | 大型项目     |
| **阿里云**  | 国内速度快     | 国内用户     |
| **Vercel**  | 自动化，零配置 | Next.js 项目 |
| **Railway** | 简单易用       | 小型项目     |

### SSH 连接服务器

```bash
# 使用密码登录
ssh root@123.45.67.89

# 使用密钥登录（更安全）
ssh -i ~/.ssh/my-key.pem root@123.45.67.89
```

### 常用 Linux 命令

```bash
# 查看文件
ls -la

# 进入目录
cd /opt/DocStudio

# 查看进程
ps aux | grep node

# 查看磁盘空间
df -h

# 查看内存
free -h

# 重启服务器
sudo reboot
```

## 11. 常见术语表

| 术语              | 中文     | 说明                     |
| ----------------- | -------- | ------------------------ |
| **Container**     | 容器     | Docker 运行实例          |
| **Image**         | 镜像     | 容器的模板               |
| **Dockerfile**    | -        | 构建镜像的脚本           |
| **Volume**        | 数据卷   | 持久化容器数据           |
| **Port Mapping**  | 端口映射 | 宿主机端口 → 容器端口    |
| **Build**         | 构建     | 将源代码打包成可执行文件 |
| **Deploy**        | 部署     | 将应用发布到服务器       |
| **Rollback**      | 回滚     | 恢复到上一个版本         |
| **Load Balancer** | 负载均衡 | 分发流量到多台服务器     |
| **Uptime**        | 运行时间 | 服务可用时长             |

## 12. 学习路径建议

### 第一阶段：入门（1-2 周）

1. 学习 Docker 基础（安装 Docker Desktop，运行几个镜像）
2. 学习环境变量（创建 `.env` 文件）
3. 使用 `docker-compose.yml` 启动数据库

### 第二阶段：实战（2-4 周）

1. 为你的项目编写 `Dockerfile`
2. 配置 Nginx 反向代理
3. 申请域名和 SSL 证书
4. 手动部署一次

### 第三阶段：自动化（1-2 周）

1. 学习 GitHub Actions
2. 编写 CI/CD 流水线
3. 实现自动部署

## 13. 推荐资源

### 视频教程

- [Docker 入门教程 - 菜鸟教程](https://www.runoob.com/docker/docker-tutorial.html)
- [Nginx 从入门到精通](https://www.bilibili.com/video/BV1F5411J7vK)

### 文档

- [Docker 官方文档](https://docs.docker.com/)
- [Nginx 官方文档](https://nginx.org/en/docs/)
- [Let's Encrypt](https://letsencrypt.org/)

### 实战平台

- [Play with Docker](https://labs.play-with-docker.com/) - 在线 Docker 环境
- [Railway](https://railway.app/) - 零配置部署平台

---

**下一步**：现在你已经掌握了基础概念，可以继续阅读《部署完整指南》了！
