# Next.js 开发必备知识指南 (App Router)

本文档整理了开发 Next.js 应用所需的关键知识点，重点关注 App Router 架构。

## 1. 核心架构与渲染机制

### Server Components (服务端组件) - **默认**

- **本质**: 在服务端渲染 HTML，发送给浏览器。代码不会打包到客户端 Bundle 中。
- **优势**:
  - 直接访问后端资源 (DB, File System)。
  - 零 Bundle Size 开销 (适合大型依赖库)。
  - 更安全 (密钥不暴露给客户端)。
- **限制**: 不能使用 Hooks (`useState`, `useEffect`), 不能绑定事件 (`onClick`)。

### Client Components (客户端组件)

- **声明**: 文件顶部添加 `"use client"`。
- **本质**: 在服务端预渲染 HTML (SSR) + 客户端 Hydration (注水)。
- **场景**: 交互组件 (Button, Input), 使用 Browser API (window, localStorage), 使用 Hooks。
- **最佳实践**: 尽可能将 Client Component **下沉** 到组件树的末端 (Leaf Nodes)，保持外层 Layout 和 Data Fetching 为 Server Component。

### 渲染边界 (Boundary)

- Server Component 可以导入 Client Component。
- **注意**: Client Component **不能** 直接导入/渲染 Server Component (除非作为 `children` prop 传递)。

## 2. 路由系统 (File-system based Routing)

### 常用特殊文件

- `local/page.tsx`: **页面** (UI 唯一入口)。
- `local/layout.tsx`: **布局** (共享 UI，状态保留，不重新挂载)。
- `local/template.tsx`: **模板** (类似 Layout，但导航时会重新挂载，适合重置状态)。
- `local/loading.tsx`: **加载中** (React Suspense 占位符)。
- `local/error.tsx`: **错误处理** (Error Boundary，必须是 `"use client"`)。
- `local/not-found.tsx`: **404 页面**。
- `api/route.ts`: **API 端点** (Response/Request 处理)。

### 高级路由模式

- **动态路由**: `app/docs/[slug]/page.tsx` -> `params.slug`。
- **捕获所有段**: `app/shop/[...slug]/page.tsx`。
- **路由组 (Route Groups)**: `app/(auth)/login/page.tsx` -> URL 为 `/login` (括号目录不参与 URL 路径，用于组织代码或应用不同 Layout)。
- **平行路由 (Parallel Routes)**: `@folder`，用于在同一 Layout 中渲染多个页面 (Dashboard 面板)。
- **拦截路由 (Intercepting Routes)**: `(..)`，用于 Modal/模态框场景 (URL 变化但保持当前页面背景)。

## 3. 深入理解 SSR 与渲染模式

在 Next.js App Router 中，渲染策略非常灵活。

### 动态渲染 (Dynamic Rendering / SSR)

当服务端组件在请求时 (Request Time) 被渲染，即称为 Dynamic Rendering。

- **触发条件**:
  - 使用了动态函数: `cookies()`, `headers()`, `searchParams`。
  - 使用了不缓存的数据请求: `fetch(..., { cache: 'no-store' })`。
- **优势**: 展示实时数据，根据请求头个性化内容。

### 静态渲染 (Static Rendering / SSG) - **默认**

如果在构建时 (Build Time) 就能确定内容，Next.js 会生成静态 HTML。

- **优势**: 极致性能 (CDN 缓存)，降低服务端负载。
- **场景**: 博客文章、营销页面、文档。

### 流式渲染 (Streaming SSR)

结合 React Suspense，服务端可以逐步发送 HTML 到客户端。

- **解决痛点**: 传统 SSR 必须等待所有数据取完才能发送 HTML (All or Nothing)。Streaming 允许先发送 Layout 和骨架屏，慢数据加载完后再"流"过去补全。
- **用法**:
  ```tsx
  <Suspense fallback={<LoadingSkeleton />}>
    <SlowDataComponent />
  </Suspense>
  ```

### Hydration (注水)

SSR 返回的是"干"的 HTML。浏览器下载完 JS 后，React 接管页面，绑定事件监听器，使其变"活"。

- **注意**: 仅 Client Components 需要 Hydration。保持 Client Components 越少越好，可以减少 Hydration 的开销，提升 TTI (Time to Interactive)。

## 4. 数据获取与缓存 (Data Fetching & Caching)

### 服务端获取 (Server Components)

Next.js 扩展了 `fetch` API，自动处理去重和缓存。

```typescript
// 1. 静态生成 (默认) - (Static Site Generation/Caching)
fetch('https://...', { cache: 'force-cache' });

// 2. 动态渲染 (SSR) - (Server-Side Rendering)
fetch('https://...', { cache: 'no-store' });

// 3. 增量静态再生 (ISR) - (Incremental Static Regeneration)
// 类似 SSG，但允许在 N 秒后重新生成
fetch('https://...', { next: { revalidate: 3600 } });
```

### Server Actions (突变与表单)

用于在服务端执行写操作 (无需创建 API Routes)。

```typescript
// action.ts
'use server';

export async function createTodo(formData: FormData) {
  const title = formData.get('title');
  await db.todo.create({ data: { title } });
  revalidatePath('/todos'); // 刷新该路径缓存
}
```

```tsx
// component.tsx
import { createTodo } from './actions';

export default function Form() {
  return (
    <form action={createTodo}>
      <input name="title" />
      <button type="submit">Add</button>
    </form>
  );
}
```

## 5. 状态管理 (State Management)

1.  **URL State (推荐)**: 搜索参数 (`searchParams`) 是处理筛选、分页、Tab 的最佳位置。可分享、书签。
    - 工具: `useSearchParams`, `usePathname`, `useRouter`。
    - 库推荐: `nuqs` (Type-safe search params state)。
2.  **Server State**: React Query / SWR (主要用于 Client Components 需要频繁轮询或复杂缓存策略时)。通常 Server Components 直接获取数据即可。
3.  **Client Global State**: Zustand / Context API (用于 UI 状态，如 Sidebar 开关、Theme)。

## 6. 样式与 UI (Styling)

- **Tailwind CSS**: Next.js 标配。
  - 工具: `clsx` + `tailwind-merge` (合并类名神器，解决冲突)。
  - 组织: 使用 `cva` (Class Variance Authority) 管理组件变体。
- **CSS Modules**: `styles.module.css` (如果不喜欢 Tailwind)。
- **字体优化**: `next/font`. 自动托管 Google Fonts，零布局偏移 (CLS)。

## 7. SEO 与 Metadata

支持静态和动态 Metadata。

```typescript
import type { Metadata } from 'next';

// 静态
export const metadata: Metadata = {
  title: 'DocStudio',
  description: 'Documentation Platform',
};

// 动态
export async function generateMetadata({ params }): Promise<Metadata> {
  const product = await getProduct(params.id);
  return {
    title: product.title,
    openGraph: {
      images: [product.coverImage],
    },
  };
}
```

## 8. 中间件 (Middleware)

`middleware.ts` 运行在 Edge Runtime。

- **用途**: 身份验证 (Auth)、国际化路由重定向 (i18n)、A/B 测试、重写路径 (Rewrites)。
- **注意**: 不能在 Middleware 中直接访问 Node.js API (如连接数据库)，只能处理 Request/Response。

## 9. 常备工具库推荐

- **组件库**: Shadcn/ui (基于 Radix UI + Tailwind，源码拷贝模式)。
- **表单**: React Hook Form + Zod (Schema 验证)。
- **日期**: date-fns 或 dayjs。
- **图标**: Lucide React.
