# è¶…çº§ç®¡ç†å‘˜ç³»ç»Ÿå¼€å‘æŒ‡å—

æœ¬æ–‡æ¡£ä»‹ç» DocStudio ä¸­è¶…çº§ç®¡ç†å‘˜ï¼ˆSuper Adminï¼‰ç³»ç»Ÿçš„å®Œæ•´å¼€å‘è¿‡ç¨‹ï¼Œæ¶µç›–æ•°æ®åº“æ‰©å±•ã€åç«¯é‰´æƒã€è‡ªåŠ¨åˆå§‹åŒ–ã€API è®¾è®¡å’Œå‰ç«¯é›†æˆã€‚

---

## 1. æ ¸å¿ƒæ¦‚å¿µ

### è¶…ç®¡ vs æ™®é€šç”¨æˆ·

| ç»´åº¦     | æ™®é€šç”¨æˆ·                 | è¶…çº§ç®¡ç†å‘˜               |
| -------- | ------------------------ | ------------------------ |
| æƒé™èŒƒå›´ | è‡ªå·±çš„ç©ºé—´ï¼ˆSpace çº§åˆ«ï¼‰ | æ•´ä¸ªå¹³å°ï¼ˆç³»ç»Ÿçº§åˆ«ï¼‰     |
| è§’è‰²è½½ä½“ | `SpacePermission.role`   | `User.isSuperAdmin`      |
| é™åˆ¶     | åªèƒ½ç®¡ç†è‡ªå·±æœ‰æƒé™çš„èµ„æº | å¯æŸ¥çœ‹/ä¿®æ”¹/åˆ é™¤ä»»æ„ç”¨æˆ· |

### å…³é”®å­—æ®µ

```prisma
model User {
  // ...å·²æœ‰å­—æ®µ...
  isSuperAdmin Boolean @default(false) // æ˜¯å¦ä¸ºå¹³å°è¶…ç®¡
  isDisabled   Boolean @default(false) // æ˜¯å¦è¢«ç¦ç”¨ï¼ˆç¦æ­¢ç™»å½•ï¼‰
}
```

---

## 2. æ•°æ®åº“è¿ç§»

åœ¨ `prisma/schema.prisma` çš„ `User` æ¨¡å‹ä¸­æ·»åŠ å­—æ®µåï¼Œæ‰§è¡Œè¿ç§»ï¼š

```bash
cd apps/api
npx prisma migrate dev --name add_super_admin_and_disabled
```

è¿ç§»ä¼šè‡ªåŠ¨ï¼š

1. åœ¨ PostgreSQL çš„ `users` è¡¨æ–°å¢ä¸¤åˆ—ï¼ˆé»˜è®¤ `false`ï¼‰
2. é‡æ–°ç”Ÿæˆ Prisma Clientï¼Œä½¿æ–°å­—æ®µå¯è¢«ä»£ç å¼•ç”¨

---

## 3. åç«¯é‰´æƒå±‚

### 3.1 æ›´æ–° JwtStrategy â€” å®æ—¶æ£€æŸ¥ç¦ç”¨çŠ¶æ€

`JwtStrategy.validate()` åœ¨**æ¯æ¬¡è¯·æ±‚**éƒ½ä¼šæ‰§è¡Œã€‚åœ¨è¿™é‡Œå¢åŠ  `isDisabled` æ£€æŸ¥ï¼Œå¯ç¡®ä¿ç¦ç”¨ç«‹åˆ»ç”Ÿæ•ˆï¼ˆä¸‹æ¬¡è¯·æ±‚èµ·ï¼‰ï¼š

```typescript
// src/auth/strategies/jwt.strategy.ts
interface JwtPayload {
  sub: string;  // userId
  email: string;
}

@Injectable()
export class JwtStrategy extends PassportStrategy(Strategy) {
  constructor(private usersService: UsersService) { ... }

  async validate(payload: JwtPayload) {
    const user = await this.usersService.findById(payload.sub);

    if (!user) throw new UnauthorizedException('ç”¨æˆ·ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤');

    // âœ¨ æ–°å¢ï¼šæ¯æ¬¡è¯·æ±‚éƒ½å®æ—¶æŸ¥åº“æ£€æŸ¥ç¦ç”¨çŠ¶æ€
    if (user.isDisabled) throw new ForbiddenException('è´¦å·å·²è¢«ç¦ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');

    return user; // æ³¨å…¥åˆ° request.user
  }
}
```

> **ä¸ºä»€ä¹ˆ validate é‡Œè¦æŸ¥åº“è€Œä¸ç”¨ Token å†…çš„å­—æ®µï¼Ÿ**
> JWT æ˜¯æ— çŠ¶æ€çš„ï¼Œä¸€æ—¦ç­¾å‘å°±æ— æ³•æ’¤å›ã€‚å¦‚æœç¦ç”¨ä¿¡æ¯åªå­˜åœ¨ Token é‡Œï¼Œç¦ç”¨æ“ä½œè¦ç­‰ Token è‡ªç„¶è¿‡æœŸæ‰èƒ½ç”Ÿæ•ˆã€‚é€šè¿‡æ¯æ¬¡è¯·æ±‚æŸ¥åº“ï¼Œç¦ç”¨å³æ—¶ç”Ÿæ•ˆã€‚

### 3.2 æ–°å»º SuperAdminGuard

Guard ä½œä¸º**è·¯ç”±çº§åˆ«çš„å®ˆå«**ï¼Œåœ¨è¿›å…¥ Controller æ–¹æ³•å‰æ‰§è¡Œï¼š

```typescript
// src/common/guards/super-admin.guard.ts
@Injectable()
export class SuperAdminGuard implements CanActivate {
  canActivate(context: ExecutionContext): boolean {
    // request.user å·²ç”± JwtStrategy.validate() æ³¨å…¥
    const user = context.switchToHttp().getRequest().user;
    if (!user?.isSuperAdmin) {
      throw new ForbiddenException('ä»…è¶…çº§ç®¡ç†å‘˜å¯è®¿é—®');
    }
    return true;
  }
}
```

**ä½¿ç”¨æ–¹å¼** â€” æŒ‚è½½åœ¨ Controller **ç±»çº§åˆ«**ï¼Œæ‰€æœ‰æ–¹æ³•è‡ªåŠ¨ç»§æ‰¿ï¼š

```typescript
@UseGuards(JwtAuthGuard, SuperAdminGuard) // é¡ºåºé‡è¦ï¼šå…ˆéªŒè¯ç™»å½•ï¼Œå†éªŒè¯è¶…ç®¡èº«ä»½
@Controller('admin')
export class AdminController { ... }
```

> **Guard æ‰§è¡Œé¡ºåº**ï¼š`JwtAuthGuard` â†’ `SuperAdminGuard`ã€‚å‰è€…è´Ÿè´£è§£æ Token å¹¶æŠŠç”¨æˆ·æ³¨å…¥ `request.user`ï¼Œåè€…æ‰èƒ½ä» `request.user` å–åˆ° `isSuperAdmin`ã€‚ä¸¤è€…**ç¼ºä¸€ä¸å¯**ã€‚

---

## 4. è¶…ç®¡è‡ªåŠ¨åˆå§‹åŒ–ï¼ˆBootstrapï¼‰

### éœ€æ±‚

é¦–æ¬¡éƒ¨ç½²æ—¶è‡ªåŠ¨åˆ›å»ºé»˜è®¤è¶…ç®¡è´¦å·ï¼Œé¿å…æ‰‹åŠ¨æ“ä½œã€‚ä¸”å…·æœ‰**å¹‚ç­‰æ€§**ï¼ˆé‡å¤å¯åŠ¨ä¸ä¼šé‡å¤åˆ›å»ºï¼‰ã€‚

### å®ç°ï¼šOnApplicationBootstrap

NestJS æä¾› `OnApplicationBootstrap` ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œåœ¨æ‰€æœ‰æ¨¡å—åŠ è½½å®Œæˆåï¼ˆæ•°æ®åº“è¿æ¥å»ºç«‹åï¼‰æ‰§è¡Œä¸€æ¬¡ï¼š

```typescript
// src/admin/admin-bootstrap.service.ts
@Injectable()
export class AdminBootstrapService implements OnApplicationBootstrap {
  private readonly logger = new Logger(AdminBootstrapService.name);

  constructor(private readonly prisma: PrismaService) {}

  async onApplicationBootstrap() {
    // å¹‚ç­‰æ£€æŸ¥ï¼šå·²å­˜åœ¨è¶…ç®¡åˆ™ç›´æ¥è·³è¿‡
    const existing = await this.prisma.user.findFirst({
      where: { isSuperAdmin: true } as any,
    });
    if (existing) {
      this.logger.log('è¶…çº§ç®¡ç†å‘˜å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–');
      return;
    }

    // è¯»å–ç¯å¢ƒå˜é‡ï¼Œæä¾›åˆç†é»˜è®¤å€¼ï¼ˆå¼€å‘ç¯å¢ƒç”¨ï¼‰
    const email = process.env.SUPER_ADMIN_EMAIL ?? 'admin@doc-studio.com';
    const password = process.env.SUPER_ADMIN_PASSWORD ?? 'admin';

    // å¯†ç å“ˆå¸Œå¤„ç†ä¸æ™®é€šç”¨æˆ·å®Œå…¨ä¸€è‡´
    const hashedPassword = await bcrypt.hash(password, 10);

    await this.prisma.user.create({
      data: { email, name: email, password: hashedPassword, isSuperAdmin: true } as any,
    });

    this.logger.log(`[Bootstrap] è¶…çº§ç®¡ç†å‘˜è´¦å·å·²åˆ›å»ºï¼Œé‚®ç®±: ${email}`);
  }
}
```

åœ¨ `.env` / `.env.example` ä¸­æ·»åŠ ï¼š

```env
# ==================== è¶…çº§ç®¡ç†å‘˜é…ç½® ====================
# ç”Ÿäº§ç¯å¢ƒè¯·åŠ¡å¿…é€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–ï¼
SUPER_ADMIN_EMAIL=admin@doc-studio.com
SUPER_ADMIN_PASSWORD=admin
```

---

## 5. Admin API è®¾è®¡

### 5.1 æ¨¡å—ç»“æ„

```
src/admin/
â”œâ”€â”€ admin.module.ts             # æ¨¡å—æ³¨å†Œ
â”œâ”€â”€ admin.controller.ts         # è·¯ç”±ï¼ˆå…¨éƒ¨æŒ‚ JwtAuthGuard + SuperAdminGuardï¼‰
â”œâ”€â”€ admin.service.ts            # ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€ admin-bootstrap.service.ts  # å¯åŠ¨åˆå§‹åŒ–
â””â”€â”€ dto/
    â”œâ”€â”€ admin-user-query.dto.ts     # åˆ—è¡¨æŸ¥è¯¢å‚æ•°
    â”œâ”€â”€ update-user-password.dto.ts # ä¿®æ”¹å¯†ç 
    â””â”€â”€ update-user-status.dto.ts   # ç¦ç”¨/å¯ç”¨
```

### 5.2 æ¥å£ä¸€è§ˆ

> [!IMPORTANT]
> æ‰€æœ‰ `/admin/*` æ¥å£éƒ½éœ€è¦ `JwtAuthGuard + SuperAdminGuard` ä¸¤å±‚é‰´æƒã€‚éè¶…ç®¡è°ƒç”¨ä¸€å¾‹è¿”å› `403 Forbidden`ã€‚

| æ–¹æ³•   | è·¯å¾„                            | è¯´æ˜                               |
| ------ | ------------------------------- | ---------------------------------- |
| GET    | `/admin/users`                  | ç”¨æˆ·åˆ—è¡¨ï¼ˆåˆ†é¡µ + æœç´¢ + ç©ºé—´ç­›é€‰ï¼‰ |
| GET    | `/admin/users/:userId`          | ç”¨æˆ·è¯¦æƒ…ï¼ˆå«å®Œæ•´ç©ºé—´åˆ—è¡¨ï¼‰         |
| PATCH  | `/admin/users/:userId/password` | ä¿®æ”¹ä»»æ„ç”¨æˆ·å¯†ç                    |
| PATCH  | `/admin/users/:userId/status`   | ç¦ç”¨ / å¯ç”¨ç”¨æˆ·                    |
| DELETE | `/admin/users/:userId`          | åˆ é™¤ç”¨æˆ·ï¼ˆçº§è”åˆ é™¤æ‰€æœ‰æ•°æ®ï¼‰       |
| GET    | `/admin/spaces`                 | æ‰€æœ‰ç©ºé—´åˆ—è¡¨ï¼ˆç”¨äºå‰ç«¯ç­›é€‰ä¸‹æ‹‰ï¼‰   |

### 5.3 AdminService å…³é”®å®ç°

**ç”¨æˆ·åˆ—è¡¨ â€” åˆ†é¡µ + æœç´¢ + ç©ºé—´ç­›é€‰ï¼š**

```typescript
async getUsers(query: AdminUserQueryDto) {
  const page  = Math.max(1, parseInt(query.page  ?? '1',  10));
  const limit = Math.min(100, parseInt(query.limit ?? '20', 10));

  const where: Prisma.UserWhereInput = {};

  if (query.search) {
    where.OR = [
      { name:  { contains: query.search, mode: 'insensitive' } },
      { email: { contains: query.search, mode: 'insensitive' } },
    ];
  }
  if (query.spaceId) {
    where.spacePermissions = { some: { spaceId: query.spaceId } };
  }

  const [users, total] = await Promise.all([
    this.prisma.user.findMany({
      where, skip: (page-1)*limit, take: limit,
      orderBy: { createdAt: 'desc' },
      include: { _count: { select: { spacePermissions: true, createdDocuments: true } } },
    }),
    this.prisma.user.count({ where }),
  ]);

  return { data: users.map(formatUser), total, page, limit };
}
```

**å®‰å…¨ä¿æŠ¤è§„åˆ™ â€” ç¦æ­¢æ“ä½œè¶…ç®¡å’Œè‡ªèº«ï¼š**

```typescript
async updateStatus(currentUserId: string, targetUserId: string, isDisabled: boolean) {
  const target = await this.prisma.user.findUnique({ where: { id: targetUserId } });
  if (!target) throw new NotFoundException('ç”¨æˆ·ä¸å­˜åœ¨');

  // ä¿æŠ¤è§„åˆ™
  if ((target as any).isSuperAdmin) throw new ForbiddenException('ä¸èƒ½ç¦ç”¨/å¯ç”¨è¶…çº§ç®¡ç†å‘˜è´¦å·');
  if (currentUserId === targetUserId)  throw new ForbiddenException('ä¸èƒ½ç¦ç”¨è‡ªå·±çš„è´¦å·');

  await this.prisma.user.update({ where: { id: targetUserId }, data: { isDisabled } as any });
  return { message: isDisabled ? 'ç”¨æˆ·å·²ç¦ç”¨' : 'ç”¨æˆ·å·²å¯ç”¨', isDisabled };
}
```

> åˆ é™¤æ¥å£ï¼ˆ`deleteUser`ï¼‰éµå¾ªåŒæ ·çš„ä¿æŠ¤é€»è¾‘ï¼šä¸èƒ½åˆ é™¤è¶…ç®¡ï¼Œä¸èƒ½åˆ é™¤è‡ªå·±ã€‚

---

## 6. å‰ç«¯é›†æˆ

### 6.1 æ‰©å±• User ç±»å‹

```typescript
// src/lib/api.ts
export interface User {
  id: string;
  email: string;
  name: string;
  avatarUrl?: string;
  isSuperAdmin: boolean; // âœ¨ æ–°å¢
  isDisabled: boolean; // âœ¨ æ–°å¢
  createdAt: string;
}
```

### 6.2 è·¯ç”±å®ˆå«ï¼ˆ/admin å¸ƒå±€ï¼‰

```typescript
// src/app/admin/layout.tsx
export default function AdminLayout({ children }) {
  const { user, isLoading } = useAuth();
  const router = useRouter();

  useEffect(() => {
    // æœªç™»å½•æˆ–éè¶…ç®¡ â†’ é‡å®šå‘
    if (!isLoading && (!user || !user.isSuperAdmin)) {
      router.replace('/dashboard');
    }
  }, [isLoading, user, router]);

  if (isLoading || !user?.isSuperAdmin) return null;
  return <>{/* æ­£å¸¸æ¸²æŸ“ */}</>;
}
```

### 6.3 ä¾§è¾¹æ è¶…ç®¡å…¥å£

```tsx
// ä»…å½“ user.isSuperAdmin === true æ—¶æ¸²æŸ“
{
  user?.isSuperAdmin && (
    <div>
      <div className="section-header">
        <Shield className="w-4 h-4" /> ç®¡ç†æ§åˆ¶å°
      </div>
      <Link href="/admin/users">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</Link>
    </div>
  );
}
```

---

## 7. å®Œæ•´è¯·æ±‚æµç¨‹

```
å‰ç«¯è¯·æ±‚ GET /admin/users
     â”‚
     â–¼
JwtAuthGuard
  è§£æ Authorization: Bearer <token>
  è°ƒç”¨ JwtStrategy.validate()
    â†’ æŸ¥åº“è·å– user
    â†’ æ£€æŸ¥ user.isDisabledï¼ˆç¦ç”¨åˆ™ 403ï¼‰
    â†’ å°† user æ³¨å…¥ request.user
     â”‚
     â–¼
SuperAdminGuard
  è¯»å– request.user.isSuperAdmin
  â†’ false â†’ 403 Forbidden
  â†’ true  â†’ æ”¾è¡Œ
     â”‚
     â–¼
AdminController.getUsers()
  è°ƒç”¨ AdminService.getUsers()
  è¿”å›åˆ†é¡µç”¨æˆ·åˆ—è¡¨
```

---

## 8. å®‰å…¨æ³¨æ„äº‹é¡¹

| è§„åˆ™             | è¯´æ˜                                                       |
| ---------------- | ---------------------------------------------------------- |
| è¶…ç®¡ä¸èƒ½æ“ä½œè¶…ç®¡ | `updateStatus` / `deleteUser` ä¸­æ£€æŸ¥ `target.isSuperAdmin` |
| ä¸èƒ½æ“ä½œè‡ªå·±     | æ¯”è¾ƒ `currentUserId === targetUserId`                      |
| å‰ç«¯åŒæ­¥ç°æ˜¾     | æ“ä½œèœå•å¯¹å—ä¿æŠ¤å¯¹è±¡ç¦ç”¨æŒ‰é’®ï¼Œæå‡ä½“éªŒ                     |
| é»˜è®¤å‡­æ®ä»…é™å¼€å‘ | ç”Ÿäº§ç¯å¢ƒ**å¿…é¡»**é€šè¿‡ç¯å¢ƒå˜é‡è®¾ç½®å¼ºå¯†ç                      |
| ç¦ç”¨å³æ—¶ç”Ÿæ•ˆ     | `JwtStrategy.validate()` æ¯æ¬¡è¯·æ±‚å®æ—¶æŸ¥åº“ï¼Œæ— éœ€ Redis      |

---

## 9. æœ¬åœ°éªŒè¯æ­¥éª¤

```bash
# 1. æ‰§è¡Œæ•°æ®åº“è¿ç§»
cd apps/api && npx prisma migrate dev --name add_super_admin_and_disabled

# 2. ç¡®è®¤ .env æœ‰è¶…ç®¡é…ç½®
#    SUPER_ADMIN_EMAIL=admin@doc-studio.com
#    SUPER_ADMIN_PASSWORD=admin

# 3. å¯åŠ¨æœåŠ¡ï¼ˆBootstrap è‡ªåŠ¨åˆ›å»ºè¶…ç®¡ï¼‰
pnpm dev

# æ§åˆ¶å°å‡ºç°ï¼š
# [AdminBootstrapService] [Bootstrap] è¶…çº§ç®¡ç†å‘˜è´¦å·å·²åˆ›å»ºï¼Œé‚®ç®±: admin@doc-studio.com
# é‡å¯åå‡ºç°ï¼š
# [AdminBootstrapService] è¶…çº§ç®¡ç†å‘˜å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–
```

ç™»å½• `admin@doc-studio.com` / `admin` åï¼Œä¾§è¾¹æ åº•éƒ¨å°†å‡ºç°ã€Œç®¡ç†æ§åˆ¶å°ã€å…¥å£ï¼Œè¿›å…¥ `/admin/users` å¯çœ‹åˆ°å®Œæ•´çš„ç”¨æˆ·ç®¡ç†ç•Œé¢ã€‚
