# Prisma 基础与使用指南

Prisma 是下一代 ORM（对象关系映射），它包含三个主要工具：Prisma Client, Prisma Migrate 和 Prisma Studio。

## 1. 核心流程 (Core Workflow)

### 1. 定义数据模型 (Schema Definition)

所有配置都在 `prisma/schema.prisma` 中。

```prisma
// 指定数据源
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 指定生成器 (生成 Client 代码)
generator client {
  provider = "prisma-client-js"
}

// 定义 Model (对应数据库表)
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  name      String?
  posts     Post[]   // 关系字段 (不真实存在于数据库)
  createdAt DateTime @default(now())
}

model Post {
  id        Int     @id @default(autoincrement())
  title     String
  content   String?
  published Boolean @default(false)
  author    User    @relation(fields: [authorId], references: [id]) // 关联配置
  authorId  Int     // 外键字段
}
```

### 2. 数据库迁移 (Migration)

当你修改了 `schema.prisma` 后，必须运行迁移来同步数据库结构。

- **开发环境**:
  ```bash
  # 生成 SQL 文件并执行，同时更新 @prisma/client
  npx prisma migrate dev --name init_users
  ```
- **生产环境/CI**:
  ```bash
  # 仅执行已生成的迁移文件，不询问确认
  npx prisma migrate deploy
  ```

### 3. 生成客户端 (Generate Client)

通常 `migrate dev` 会自动运行此步。如果手动拉取了代码，需要单独运行：

```bash
npx prisma generate
```

这会根据 schema 更新 `node_modules/.prisma/client` 中的 TypeScript 类型定义。

## 2. Prisma Client 使用 (CRUD)

而在 NestJS 中，通常封装一个 `PrismaService` 继承自 `PrismaClient`。

```typescript
// 1. 创建 (Create)
const user = await prisma.user.create({
  data: {
    email: 'test@test.com',
    name: 'Jason',
    posts: {
      // 级联创建
      create: { title: 'First Post' },
    },
  },
});

// 2. 查询 (Read)
const users = await prisma.user.findMany({
  where: {
    email: { contains: '@gmail.com' },
    published: true,
  },
  include: { posts: true }, // 联表查询 (Eager Loading)
  orderBy: { id: 'desc' },
  take: 10, // 分页: limit
  skip: 0, // 分页: offset
});

const user = await prisma.user.findUnique({
  where: { id: 1 },
});

// 3. 更新 (Update)
const updatedUser = await prisma.user.update({
  where: { id: 1 },
  data: { name: 'New Name' },
});

// 4. 删除 (Delete)
const deletedUser = await prisma.user.delete({
  where: { id: 1 },
});
```

## 3. 常见命令速查

- `npx prisma studio`: 打开 Web 界面 GUI 查看和编辑数据。
- `npx prisma db pull`: 现有数据库 -> 生成 Schema (反向工程)。
- `npx prisma db push`: Schema -> 数据库 (原型阶段使用，不生成迁移文件，慎用)。
- `npx prisma format`: 格式化 `schema.prisma` 文件。

## 4. 最佳实践

- **软删除 (Soft Delete)**: 不直接 `delete`，而是加一个 `deletedAt` 字段，查询时过滤。
- **排除字段**: 在 Service 层或使用 `class-transformer` 的 `@Exclude` 排除密码字段，Prisma 本身不支持在 Schema 层面隐藏字段。
- **事务 (Transactions)**:
  ```typescript
  await prisma.$transaction([
    prisma.post.create({ ... }),
    prisma.user.update({ ... }),
  ]);
  ```
