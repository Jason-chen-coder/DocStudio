# NestJS Swagger 接入完整指南

Swagger (OpenAPI) 是最流行的 API 文档标准。NestJS 提供了官方的 `@nestjs/swagger` 包，可以通过装饰器自动生成交互式 API 文档。

## 1. 为什么使用 Swagger？

- **自动化文档**: 代码即文档，无需手动维护。
- **交互式测试**: 在浏览器中直接测试 API，无需 Postman。
- **类型安全**: 与 TypeScript 深度集成，自动推断参数类型。
- **团队协作**: 前端可以根据 Swagger 文档快速了解 API 规范。

## 2. 安装依赖

```bash
pnpm add @nestjs/swagger
```

## 3. 基础配置

在 `src/main.ts` 中配置 Swagger：

```typescript
import { NestFactory } from '@nestjs/core';
import { ValidationPipe } from '@nestjs/common';
import { SwaggerModule, DocumentBuilder } from '@nestjs/swagger';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  // 启用全局验证管道
  app.useGlobalPipes(new ValidationPipe({ whitelist: true }));

  // Swagger 配置
  const config = new DocumentBuilder()
    .setTitle('DocStudio API') // 文档标题
    .setDescription('API 文档说明') // 文档描述
    .setVersion('1.0') // API 版本
    .addBearerAuth() // 启用 JWT 认证
    .addTag('auth', '认证相关接口') // 添加标签（用于分组）
    .addTag('users', '用户相关接口')
    .build();

  const document = SwaggerModule.createDocument(app, config);
  SwaggerModule.setup('api-docs', app, document); // 文档访问路径: /api-docs

  await app.listen(3000);
  console.log('Swagger 文档已启动: http://localhost:3000/api-docs');
}
bootstrap();
```

此时访问 `http://localhost:3000/api-docs` 即可看到自动生成的文档。

## 4. Controller 装饰器详解

### @ApiTags() - 标签分组

用于将接口分组，类似文件夹。

```typescript
import { Controller } from '@nestjs/common';
import { ApiTags } from '@nestjs/swagger';

@ApiTags('auth') // 会显示在 "auth" 分组下
@Controller('auth')
export class AuthController {
  // ...
}
```

### @ApiOperation() - 接口描述

为每个接口添加摘要和详细说明。

```typescript
import { Post } from '@nestjs/common';
import { ApiOperation } from '@nestjs/swagger';

@Post('register')
@ApiOperation({
  summary: '用户注册',
  description: '注册新用户账号，需要提供邮箱、密码和姓名'
})
async register() {
  // ...
}
```

### @ApiResponse() - 响应文档

定义不同状态码的响应格式。

```typescript
import { ApiResponse } from '@nestjs/swagger';

@Post('login')
@ApiResponse({ status: 200, description: '登录成功，返回 JWT Token' })
@ApiResponse({ status: 401, description: '邮箱或密码错误' })
async login() {
  // ...
}
```

### @ApiBody() - 请求体文档

显式声明请求体类型（通常自动推断，但有时需要手动）。

```typescript
import { ApiBody } from '@nestjs/swagger';

@Post('login')
@ApiBody({ type: LoginDto })
async login(@Body() dto: LoginDto) {
  // ...
}
```

### @ApiBearerAuth() - JWT 认证

标记需要 Bearer Token 的接口。

```typescript
import { Get, UseGuards } from '@nestjs/common';
import { ApiBearerAuth } from '@nestjs/swagger';
import { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';

@Get('profile')
@UseGuards(JwtAuthGuard)
@ApiBearerAuth() // 显示认证锁图标
async getProfile() {
  // ...
}
```

## 5. DTO 文档化

Swagger 可以通过 DTO 自动生成 Schema，但需要使用专用装饰器增强描述。

### @ApiProperty() - 字段文档

```typescript
import { IsEmail, IsString, MinLength } from 'class-validator';
import { ApiProperty } from '@nestjs/swagger';

export class RegisterDto {
  @ApiProperty({
    description: '用户邮箱',
    example: 'test@example.com',
  })
  @IsEmail()
  email: string;

  @ApiProperty({
    description: '登录密码',
    example: 'Password123!',
    minLength: 8,
  })
  @IsString()
  @MinLength(8)
  password: string;

  @ApiProperty({
    description: '用户昵称',
    example: '张三',
  })
  @IsString()
  name: string;
}
```

### @ApiPropertyOptional() - 可选字段

```typescript
import { ApiPropertyOptional } from '@nestjs/swagger';

export class UpdateUserDto {
  @ApiPropertyOptional({ description: '新昵称' })
  name?: string;

  @ApiPropertyOptional({ description: '个人简介' })
  bio?: string;
}
```

### @ApiHideProperty() - 隐藏字段

某些字段不希望出现在文档中（如内部使用的字段）。

```typescript
import { ApiHideProperty } from '@nestjs/swagger';

export class UserEntity {
  id: number;
  email: string;

  @ApiHideProperty() // 不显示在 Swagger 中
  password: string;
}
```

## 6. 完整示例：Auth Controller

```typescript
import { Controller, Post, Get, Body, UseGuards } from '@nestjs/common';
import { ApiTags, ApiOperation, ApiResponse, ApiBearerAuth } from '@nestjs/swagger';
import { AuthService } from './auth.service';
import { RegisterDto } from './dto/register.dto';
import { LoginDto } from './dto/login.dto';
import { JwtAuthGuard } from './guards/jwt-auth.guard';
import { CurrentUser } from '../common/decorators/current-user.decorator';
import { User } from '@prisma/client';

@ApiTags('auth')
@Controller('auth')
export class AuthController {
  constructor(private authService: AuthService) {}

  @Post('register')
  @ApiOperation({ summary: '用户注册' })
  @ApiResponse({ status: 201, description: '注册成功，返回 JWT Token' })
  @ApiResponse({ status: 409, description: '邮箱已被注册' })
  async register(@Body() dto: RegisterDto) {
    return this.authService.register(dto);
  }

  @Post('login')
  @ApiOperation({ summary: '用户登录' })
  @ApiResponse({ status: 200, description: '登录成功' })
  @ApiResponse({ status: 401, description: '邮箱或密码错误' })
  async login(@Body() dto: LoginDto) {
    return this.authService.login(dto);
  }

  @Get('me')
  @UseGuards(JwtAuthGuard)
  @ApiBearerAuth()
  @ApiOperation({ summary: '获取当前用户信息' })
  @ApiResponse({ status: 200, description: '返回当前登录用户信息' })
  @ApiResponse({ status: 401, description: '未登录或 Token 无效' })
  getMe(@CurrentUser() user: User) {
    return {
      id: user.id,
      email: user.email,
      name: user.name,
    };
  }
}
```

## 7. 高级功能

### 响应类型定义 (Response DTO)

创建专门的响应 DTO，提升文档可读性。

```typescript
import { ApiProperty } from '@nestjs/swagger';

export class LoginResponseDto {
  @ApiProperty({ description: 'JWT Access Token' })
  access_token: string;
}
```

在 Controller 中使用：

```typescript
@Post('login')
@ApiResponse({ status: 200, type: LoginResponseDto })
async login(@Body() dto: LoginDto): Promise<LoginResponseDto> {
  return this.authService.login(dto);
}
```

### 分页响应

```typescript
import { ApiProperty } from '@nestjs/swagger';

export class PaginatedResponseDto<T> {
  @ApiProperty()
  data: T[];

  @ApiProperty()
  total: number;

  @ApiProperty()
  page: number;

  @ApiProperty()
  pageSize: number;
}
```

### 枚举类型

```typescript
import { ApiProperty } from '@nestjs/swagger';

export enum UserRole {
  USER = 'user',
  ADMIN = 'admin',
}

export class CreateUserDto {
  @ApiProperty({ enum: UserRole, default: UserRole.USER })
  role: UserRole;
}
```

### 文件上传

```typescript
import { ApiConsumes, ApiBody } from '@nestjs/swagger';
import { UseInterceptors, UploadedFile } from '@nestjs/common';
import { FileInterceptor } from '@nestjs/platform-express';

@Post('upload')
@ApiConsumes('multipart/form-data')
@ApiBody({
  schema: {
    type: 'object',
    properties: {
      file: {
        type: 'string',
        format: 'binary',
      },
    },
  },
})
@UseInterceptors(FileInterceptor('file'))
uploadFile(@UploadedFile() file: Express.Multer.File) {
  return { filename: file.originalname };
}
```

## 8. 环境隔离

生产环境通常不希望暴露 API 文档，可以通过环境变量控制。

```typescript
async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  // 仅在开发环境启用 Swagger
  if (process.env.NODE_ENV !== 'production') {
    const config = new DocumentBuilder()
      .setTitle('DocStudio API')
      .setVersion('1.0')
      .addBearerAuth()
      .build();

    const document = SwaggerModule.createDocument(app, config);
    SwaggerModule.setup('api-docs', app, document);
  }

  await app.listen(3000);
}
```

## 9. 导出 OpenAPI JSON

Swagger 文档可以导出为 JSON 格式，供第三方工具使用（如 Postman）。

访问 `http://localhost:3000/api-docs-json` 即可下载 JSON Schema。

或者在代码中导出到文件：

```typescript
import { writeFileSync } from 'fs';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  const config = new DocumentBuilder().setTitle('API').build();
  const document = SwaggerModule.createDocument(app, config);

  // 导出到文件
  writeFileSync('./swagger.json', JSON.stringify(document, null, 2));

  SwaggerModule.setup('api-docs', app, document);
  await app.listen(3000);
}
```

## 10. Swagger UI 自定义

可以自定义 Swagger UI 的样式和行为。

```typescript
SwaggerModule.setup('api-docs', app, document, {
  swaggerOptions: {
    persistAuthorization: true, // 刷新页面后保留 Token
    tagsSorter: 'alpha', // 标签按字母排序
    operationsSorter: 'alpha', // 接口按字母排序
  },
  customSiteTitle: 'DocStudio API Docs', // 浏览器标签标题
});
```

## 11. CLI 插件（自动化增强）

NestJS Swagger 提供了 CLI 插件，可以**自动推断类型**，减少手动装饰器。

在 `nest-cli.json` 中配置：

```json
{
  "compilerOptions": {
    "plugins": [
      {
        "name": "@nestjs/swagger",
        "options": {
          "classValidatorShim": true,
          "introspectComments": true
        }
      }
    ]
  }
}
```

启用后，DTO 中的 `@ApiProperty` 可以省略，插件会自动从 `class-validator` 推断类型和验证规则。

## 12. 最佳实践

- **一致性**: 所有 Controller 都添加 `@ApiTags`，所有接口都添加 `@ApiOperation`。
- **描述性**: `summary` 简短明了，`description` 详细说明（何时可选）。
- **示例值**: DTO 中的 `example` 有助于前端快速理解数据格式。
- **错误响应**: 明确列出可能的错误状态码 (400, 401, 403, 404, 500)。
- **版本控制**: 使用 `setVersion()` 标识 API 版本，有助于向后兼容。
- **隐藏敏感信息**: 使用 `@ApiHideProperty()` 隐藏密码、密钥等字段。

## 13. 常见问题

### Q: DTO 没有显示在 Swagger 中？

A: 确保 DTO 已在 Controller 方法参数中使用，或使用 `@ApiExtraModels()` 显式注册。

### Q: 响应类型不正确？

A: 使用 `@ApiResponse({ type: YourDto })` 显式声明返回类型。

### Q: 如何测试需要登录的接口？

A: 点击右上角 "Authorize" 按钮，输入 `Bearer <your_token>`，之后所有请求会自动携带 Token。
